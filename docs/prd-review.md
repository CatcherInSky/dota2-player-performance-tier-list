# PRD 审查报告

## 审查时间
2025-01-XX

## 审查范围
- 产品需求文档：`prdv2.md`
- 数据类型定义：`src/types/dota2-gep.ts`
- 现有实现：`src/background/background.ts`
- 官方 API 文档引用

---

## 一、严重矛盾与问题

### 1.1 数据获取时机矛盾 ⚠️ **严重**

**问题描述**：
- PRD 第 36-37 行：比赛表和玩家表通过 `onNewEvents.match_ended` 事件触发，从 `onInfoUpdates2.info` 收集数据
- PRD 第 51-56 行：说明 `onInfoUpdates2` 是事件驱动的，不是循环的
- **矛盾点**：`match_ended` 是 `onNewEvents` 事件，而 `onInfoUpdates2` 是独立的事件流，两者可能不同步

**具体问题**：
1. 当 `match_ended` 事件触发时，`onInfoUpdates2.info` 可能还没有更新到最新状态
2. 如果立即从 `onInfoUpdates2.info` 读取数据，可能获取到的是旧数据
3. 没有说明如何处理数据不同步的情况

**建议修复**：
```markdown
**数据收集策略（修正）**：
- 在 `match_ended` 事件触发时，先调用 `overwolf.games.events.getInfo()` 主动获取最新快照
- 等待 `onInfoUpdates2` 的下一次更新（设置超时机制，如 3-5 秒）
- 或使用缓存机制：在 `onInfoUpdates2` 每次更新时缓存最新数据，`match_ended` 时使用缓存
```

### 1.2 比赛开始/结束判断逻辑不完整 ⚠️ **中等**

**问题描述**：
- PRD 第 44 行：比赛开始通过 `match_state_changed` 变为 `DOTA_GAMERULES_STATE_GAME_IN_PROGRESS`
- PRD 第 47 行：比赛结束通过 `match_ended` 事件
- **问题**：没有说明如果 `match_ended` 事件未触发（GEP 异常）如何处理

**建议修复**：
```markdown
**比赛结束判断（补充）**：
- 主要方式：通过 `onNewEvents.match_ended` 事件触发（最可靠）
- 备用方式：通过 `onNewEvents.match_state_changed` 事件，当 `match_state` 变为 `DOTA_GAMERULES_STATE_POST_GAME` 时
- 超时机制：如果比赛开始后超过 2 小时未收到结束事件，视为异常结束
- 数据完整性检查：收集数据时验证必要字段是否存在，缺失时记录警告日志
```

### 1.3 字段获取方式描述不一致 ⚠️ **中等**

**问题描述**：
- PRD 多处提到字段名称变体（如 `account_id` vs `steam_id`），但获取方式描述不够清晰
- 例如：第 70-79 行说从 `roster.players[].account_id` 获取，但实际可能是 `steam_id` 或 `steamId`
- 第 352 行代码中实际使用了多种变体：`player.account_id || player.steamId || player.steam_id`

**建议修复**：
```markdown
**字段获取优先级（明确）**：
- `player_id` 获取优先级：`account_id` > `steamId` > `steam_id` > `steamid`
- `player_name` 获取优先级：`player_name` > `playerName` > `name`
- 所有字段获取都需要做空值检查，如果所有变体都不存在，记录警告并使用默认值
```

---

## 二、重要遗漏

### 2.1 数据库索引设计缺失 ⚠️ **重要**

**问题描述**：
- PRD 没有提到数据库索引设计
- 对于大量数据的查询（如玩家胜率计算、评分统计），索引至关重要

**建议补充**：
```markdown
**数据库索引设计**：

#### matches 表索引
- `match_id`：唯一索引（用于快速查找比赛）
- `player_id`：索引（用于查找某玩家的所有比赛）
- `end_time`：索引（用于时间范围查询）
- `match_mode`：索引（用于按模式筛选）

#### players 表索引
- `player_id`：唯一索引（主键）
- `last_seen`：索引（用于排序）

#### accounts 表索引
- `account_id`：索引（用于查找账户）
- `updated_at`：索引（用于获取最近使用的账户）

#### ratings 表索引
- `player_id`：索引（用于查找某玩家的所有评分）
- `account_id`：索引（用于查找某账户的所有评分）
- `match_id`：索引（用于查找某比赛的所有评分）
- `created_at`：索引（用于时间排序）
- 复合索引：`(player_id, account_id)` 用于查找某账户对某玩家的评分
```

### 2.2 错误处理策略缺失 ⚠️ **重要**

**问题描述**：
- PRD 没有提到错误处理策略
- 如果 GEP 数据不完整、缺失或格式异常，如何处理？

**建议补充**：
```markdown
**错误处理策略**：

1. **数据缺失处理**：
   - 如果 `match_id` 缺失：使用时间戳生成临时 ID，记录警告
   - 如果玩家数据缺失：跳过该玩家，记录警告
   - 如果关键字段缺失：不创建记录，记录错误日志

2. **数据格式异常处理**：
   - 验证字段类型（如 `match_id` 应该是 string 或 number）
   - 验证字段范围（如 `score` 应该是 1-5）
   - 异常数据记录到错误日志，不写入数据库

3. **GEP 连接异常处理**：
   - 如果 `setRequiredFeatures` 失败：记录错误，提示用户检查游戏状态
   - 如果 `getInfo()` 失败：重试 3 次，失败后使用缓存数据
   - 如果 `onInfoUpdates2` 长时间未更新：记录警告，提示用户可能的数据延迟

4. **数据库操作异常处理**：
   - IndexedDB 操作失败：记录错误，提示用户
   - 数据写入失败：重试机制，失败后保存到临时存储
```

### 2.3 数据一致性保证缺失 ⚠️ **重要**

**问题描述**：
- PRD 没有说明如何保证数据一致性
- 例如：如果 `match_ended` 触发时，`onInfoUpdates2` 还没有更新，如何处理？

**建议补充**：
```markdown
**数据一致性保证**：

1. **数据快照机制**：
   - 在 `match_ended` 触发时，立即调用 `getInfo()` 获取最新快照
   - 如果 `getInfo()` 返回的数据不完整，等待 `onInfoUpdates2` 的下一次更新（最多 5 秒）

2. **数据验证**：
   - 创建 `matches` 记录前，验证必要字段是否存在
   - 验证玩家数量是否为 10 人
   - 验证 `match_id` 是否已存在（避免重复记录）

3. **事务处理**：
   - 使用 IndexedDB 事务确保 `matches`、`players`、`accounts` 表的数据一致性
   - 如果任何一步失败，回滚所有操作

4. **数据修复机制**：
   - 定期检查数据完整性（如每周一次）
   - 发现异常数据时，记录到修复日志
```

### 2.4 路由方案未明确 ⚠️ **中等**

**问题描述**：
- PRD 第 22 行：路由方案待定
- PRD 第 458-462 行：提到使用 React Router 或自定义路由，但没有明确选择

**建议补充**：
```markdown
**路由方案选择**：

推荐使用 **React Router v6**（商业友好协议：MIT License）

**理由**：
- 成熟稳定，社区支持好
- 支持浏览器历史 API（前进/后退按钮）
- 支持鼠标侧键（Mouse 4/5）导航
- 支持程序化导航（`useNavigate` hook）

**实现方案**：
- 使用 `BrowserRouter`（desktop 窗口）
- 路由结构：
  - `/` - 总览数据组件（状态 4）
  - `/match/:matchId` - 比赛详情组件（状态 5）
  - `/player/:playerId` - 玩家详情组件（状态 6）
- 使用 `useNavigate()` 实现前进/后退/Home 按钮
```

### 2.5 窗口透明度说明不清晰 ⚠️ **轻微**

**问题描述**：
- PRD 第 362 行：desktop 窗口"可以调透明度"
- 但 `docs/window-management.md` 说明透明度是静态配置的（manifest.json），不支持运行时动态调整

**建议修复**：
```markdown
**窗口透明度（修正）**：
- desktop 窗口：透明度在 `manifest.json` 中静态配置（`transparent: false`），不支持运行时动态调整
- ingame 窗口：透明度在 `manifest.json` 中静态配置（`transparent: true`），用于 overlay 效果
- 如果需要动态调整透明度，需要在窗口内使用 CSS `opacity` 属性（但这只影响窗口内容，不影响窗口本身）
```

### 2.6 数据导入/导出功能未详细说明 ⚠️ **中等**

**问题描述**：
- PRD 第 833 行：提到"数据导入、导出、删除全部按钮"，但没有详细说明

**建议补充**：
```markdown
**数据导入/导出功能**：

1. **数据导出**：
   - 导出格式：JSON 文件
   - 导出内容：所有表的数据（matches、players、accounts、ratings）
   - 导出时机：用户手动触发
   - 文件命名：`dota2-performance-backup-YYYY-MM-DD.json`

2. **数据导入**：
   - 导入格式：JSON 文件（与导出格式一致）
   - 导入策略：
     - 检查数据格式有效性
     - 检查数据完整性
     - 合并策略：根据 `uuid` 判断是否已存在，存在则更新，不存在则新增
   - 导入时机：用户手动选择文件

3. **删除全部数据**：
   - 确认对话框：防止误操作
   - 删除所有表的数据
   - 删除后无法恢复（除非有备份）
```

---

## 三、逻辑不一致

### 3.1 账户表更新逻辑不一致 ⚠️ **中等**

**问题描述**：
- PRD 第 180-206 行：账户表更新策略说明根据 `account_id` 和 `name` 判断
- PRD 第 200-206 行：如果 `account_id` 相同但 `name` 不同，新增记录
- **问题**：这样会导致同一个账户有多条记录，查询"当前账户"时需要按 `updated_at` 排序取第一条，逻辑复杂

**建议修复**：
```markdown
**账户表更新策略（优化）**：

方案 A（推荐）：只保留最新名称
- 如果 `account_id` 存在，更新 `name` 和 `updated_at`
- 如果 `name` 变化，将旧名称添加到 `previous_names` 字段（如果 accounts 表有该字段）

方案 B（当前方案）：保留历史记录
- 如果 `account_id` 和 `name` 组合不存在，新增记录
- 如果 `account_id` 相同但 `name` 不同，新增记录（保留历史）
- 查询当前账户：按 `account_id` 查询，按 `updated_at` 降序排序，取第一条
```

### 3.2 评分表 match_id 获取时机不明确 ⚠️ **中等**

**问题描述**：
- PRD 第 793 行：`match_id` 从 `onInfoUpdates2.info.match_info.pseudo_match_id` 获取
- **问题**：在 ingame 窗口的编辑评价组件中，如何获取 `match_id`？是通过消息传递还是主动查询？

**建议修复**：
```markdown
**评分表 match_id 获取（明确）**：

1. **通过消息传递**（推荐）：
   - background 在 `match_ended` 事件触发时，发送 `MATCH_INFO` 消息给 ingame 窗口
   - 消息包含 `match_id`（`pseudo_match_id`）

2. **通过主动查询**（备用）：
   - ingame 窗口在显示编辑评价组件时，调用 `overwolf.games.events.getInfo()` 获取当前 `match_id`
   - 如果获取失败，使用最近一次 `onInfoUpdates2` 缓存的 `match_id`

3. **数据验证**：
   - 保存评分前，验证 `match_id` 是否存在
   - 如果不存在，记录警告，使用临时 ID
```

---

## 四、文档质量问题

### 4.1 标题错误 ⚠️ **轻微**

**问题描述**：
- PRD 第 1 行：`# 主要参考参考`（"参考"重复）

**建议修复**：
```markdown
# 主要参考资料
```

### 4.2 术语不一致 ⚠️ **轻微**

**问题描述**：
- PRD 中混用了多种术语：
  - `game_mode` vs `match_mode`（第 65-66 行）
  - `EPM` vs `XPM`（第 110-119 行，数据表用 EPM，但 GEP 提供 XPM）

**建议统一**：
```markdown
- 统一使用 `match_mode`（数据表字段名）
- 统一使用 `XPM`（与 GEP 保持一致），数据表字段名可以是 `player_X_xpm` 或 `player_X_epm`（内部统一即可）
```

---

## 五、功能完整性检查

### 5.1 缺失的功能说明

1. **数据统计功能**：
   - PRD 提到计算胜率、平均评分等，但没有说明计算逻辑
   - 建议补充：如何判断"同队"和"对战"（根据 `matches` 表中的 `player_X_id` 和当前 `player_id` 比较）

2. **词云功能**：
   - PRD 第 722-725 行：提到词云，但没有说明：
     - 使用哪个库？（需要检查商业友好协议）
     - 如何处理中文分词？
     - 词云更新频率？

3. **设置页面**：
   - PRD 第 828-835 行：提到设置页面，但没有详细说明每个设置项的具体实现

4. **性能优化**：
   - PRD 第 579 行：提到虚拟滚动，但没有说明何时使用（数据量阈值？）

---

## 六、PRD 评价总结

### 优点 ✅

1. **结构清晰**：文档结构合理，分为数据、事件、页面等模块
2. **数据表设计完整**：所有表都有详细的字段说明
3. **事件流程清晰**：事件监听机制说明清楚
4. **实现可行性考虑**：每个功能都标注了实现可行性

### 需要改进的地方 ⚠️

1. **数据获取时机矛盾**：需要明确 `match_ended` 和 `onInfoUpdates2` 的同步机制
2. **错误处理缺失**：需要补充完整的错误处理策略
3. **数据一致性保证**：需要说明如何保证数据一致性
4. **数据库索引设计**：需要补充索引设计
5. **路由方案未明确**：需要明确选择路由方案
6. **部分功能描述不够详细**：如数据导入/导出、词云等

### 总体评分

- **完整性**：7/10（缺少错误处理、索引设计等）
- **准确性**：6/10（存在数据获取时机矛盾、字段获取方式不一致等问题）
- **清晰性**：8/10（结构清晰，但部分描述不够详细）
- **可行性**：7/10（大部分功能可行，但需要解决数据同步问题）

**综合评分**：**7/10**

---

## 七、建议的修复优先级

### 高优先级（必须修复）

1. ✅ 修复数据获取时机矛盾（第 1.1 节）
2. ✅ 补充错误处理策略（第 2.2 节）
3. ✅ 补充数据一致性保证（第 2.3 节）
4. ✅ 补充数据库索引设计（第 2.1 节）

### 中优先级（建议修复）

5. ✅ 明确路由方案选择（第 2.4 节）
6. ✅ 修复账户表更新逻辑（第 3.1 节）
7. ✅ 明确评分表 match_id 获取方式（第 3.2 节）
8. ✅ 补充数据导入/导出详细说明（第 2.6 节）

### 低优先级（可选修复）

9. ✅ 修复标题错误（第 4.1 节）
10. ✅ 统一术语（第 4.2 节）
11. ✅ 补充功能详细说明（第 5.1 节）

---

## 八、参考建议

1. **参考官方示例**：
   - 查看 `https://github.com/overwolf/events-sample-apps/tree/master/dota-events-sample-app-master` 中的实际实现
   - 验证数据获取时机和处理方式

2. **测试验证**：
   - 在实际开发中，需要测试 `match_ended` 和 `onInfoUpdates2` 的时序关系
   - 验证字段名称变体的实际使用情况

3. **文档更新**：
   - 建议在实现过程中，及时更新 PRD，记录实际遇到的问题和解决方案
   - 建立变更日志，跟踪 PRD 的修改历史

