# DOTA2 玩家锐评器 PRD

## 项目概述

一个基于 Overwolf 平台的 Dota 2 应用，用于记录和查看队友、对手的历史表现评价。在策略时间阶段展示历史评分，游戏结束后进行点评，建立个人的玩家评价数据库。

---

## 1. 核心功能

### 1.1 功能描述
- 在策略时间阶段展示当前对局所有玩家（除自己外的9人）的历史评分
- 游戏结束后对所有玩家进行评分和评论
- 本地存储所有历史评价数据
- 查看历史对局记录和玩家统计信息

### 1.2 应用定位
- 个人使用工具，所有数据存储在本地
- 准备在 Overwolf 平台公开发布
- 完全合规，不影响游戏公平性

---

## 2. 技术框架

### 2.1 技术栈
- **平台**: Overwolf Electron (ow-electron)
- **前端框架**: React 18+ + TypeScript
- **UI 框架**: TailwindCSS + shadcn/ui
- **数据库**: IndexedDB (Dexie.js)
- **游戏数据**: Overwolf GEP (Game Events Provider)
- vite

### 2.2 开源协议要求
- 所有依赖库必须使用商业友好协议（MIT、Apache 2.0 等）
- 避免使用 GPL 等感染性协议

### 2.3 Overwolf 集成要点
- 使用 Overwolf GEP 获取游戏状态和玩家数据
- 参考文档: https://dev.overwolf.com/ow-electron/live-game-data-gep/supported-games/dota-2#game_state
- **重要**: 需要用户在 Dota 2 启动选项中添加 `-gamestateintegration` 参数

---

## 3. 游戏生命周期与数据获取

### 3.1 游戏状态监听

基于 Overwolf GEP 的游戏状态事件流程：

```
DOTA_GAMERULES_STATE_WAIT_FOR_PLAYERS_TO_LOAD
    ↓
DOTA_GAMERULES_STATE_HERO_SELECTION (选人阶段)
    ↓ 
DOTA_GAMERULES_STATE_STRATEGY_TIME (策略时间，30-60秒)
    ↓ 获取 roster 数据, 展示记录小窗，显示所有玩家历史评分
DOTA_GAMERULES_STATE_PRE_GAME
    ↓
DOTA_GAMERULES_STATE_GAME_IN_PROGRESS (游戏进行中)
    ↓ 
DOTA_GAMERULES_STATE_POST_GAME
    ↓
DOTA_GAMERULES_STATE_TEAM_SHOWCASE (结算界面)
    ↓ 记录游戏结果数据（击杀、死亡等）,展示点评小窗，供用户点评所有玩家
```

### 3.2 数据获取时机

| 阶段 | 获取数据 | 用途 |
|------|---------|------|
| STRATEGY_TIME | roster, match_info, me | 获取所有玩家信息，展示记录小窗 |
| TEAM_SHOWCASE | match_ended, kill/death/assist等 | 记录比赛数据，展示点评小窗 |

### 3.3 关键 GEP 事件

**必须监听的事件**：
- `game_state_changed`: 判断游戏状态（playing/spectating/idle）
- `match_state_changed`: 获取当前游戏阶段
- `roster`: 获取所有玩家信息（steam_id, hero, team, name）
- `match_info`: 获取比赛信息（pseudo_match_id, game_mode, team_score）
- `me`: 获取本地玩家信息（team, steam_id, hero）
- `match_ended`: 游戏结束事件

**roster 数据格式说明**：
包含 players 数组，每个玩家对象包含：steamid、account_id、hero、hero_id、team、player_name、pro 等字段。详见 Overwolf 官方文档。

### 3.4 游戏模式过滤

**仅记录以下模式**（通过 `game_mode` 字段判断）：
- All Pick (普通匹配)
- Ranked All Pick (天梯模式)
- Turbo (快速模式)

**不记录**：
- 观战模式（`game_state` 为 `spectating`）
- 人机对战
- 自定义游戏
- Demo 回放
- Ability Draft 等特殊模式

---

## 4. 数据库设计

### 4.1 技术方案
- 使用 IndexedDB（Dexie.js 封装）
- 数据存储在用户本地，应用卸载后数据保留
- 支持数据导出/导入（JSON 格式）

### 4.2 数据表结构

#### 4.2.1 比赛表 (matches)

| 字段 | 类型 | 说明 | 索引 |
|------|------|------|------|
| id | string | 主键，使用 pseudo_match_id 或自生成 UUID | 主键 |
| match_id | string? | Dota2 官方 Match ID（如果可获取） | 索引 |
| game_mode | string | 游戏模式（All Pick, Ranked, Turbo 等） | - |
| start_time | number | 游戏开始时间戳 | 索引 |
| end_time | number? | 游戏结束时间戳 | - |
| duration | number? | 游戏时长（秒） | - |
| result | 'win' \| 'lose' \| 'unknown' | 本方胜负 | - |
| player_team | 'radiant' \| 'dire' | 本地玩家所在队伍 | - |
| radiant_score | number? | 天辉击杀数 | - |
| dire_score | number? | 夜魇击杀数 | - |
| created_at | number | 记录创建时间 | 索引 |

#### 4.2.2 玩家表 (players)

| 字段 | 类型 | 说明 | 索引 |
|------|------|------|------|
| steam_id | string | 主键，64位 Steam ID | 主键 |
| account_id | number | 32位账户ID | 索引 |
| current_name | string | 当前昵称 | 索引 |
| name_history | string[] | 曾用名列表（不包含当前名称，去重） | - |
| first_seen | number | 首次遇到时间戳 | - |
| last_seen | number | 最后遇到时间戳 | 索引 |
| avg_score | number? | 平均评分（冗余字段，优化查询） | - |
| review_count | number? | 被评价总次数 | - |
| last_review_score | number? | 最后一次评分 | - |
| last_review_comment | string? | 最后一次评论 | - |

**昵称更新逻辑**：
每次遇到玩家时，如果昵称变化，将旧昵称加入曾用名列表。曾用名列表需要去重，且不包含当前昵称。

#### 4.2.3 比赛玩家表 (match_players)

记录每场比赛中每个玩家的信息（不在数据页面展示，仅供查询）

| 字段 | 类型 | 说明 | 索引 |
|------|------|------|------|
| id | string | 主键，`${match_id}_${steam_id}` | 主键 |
| match_id | string | 外键，关联 matches.id | 索引 |
| steam_id | string | 外键，关联 players.steam_id | 索引 |
| team | 'radiant' \| 'dire' | 所在队伍 | - |
| hero | string | 英雄名称（如 npc_dota_hero_pudge） | - |
| hero_id | number | 英雄ID | - |
| kills | number? | 击杀数 | - |
| deaths | number? | 死亡数 | - |
| assists | number? | 助攻数 | - |
| level | number? | 最终等级 | - |

#### 4.2.4 点评表 (reviews)

| 字段 | 类型 | 说明 | 索引 |
|------|------|------|------|
| id | string | 主键，`${match_id}_${steam_id}` | 主键 |
| match_id | string | 外键，关联 matches.id | 索引 |
| steam_id | string | 被评价的玩家 Steam ID | 索引 |
| reviewer_steam_id | string | 评价者 Steam ID（本地玩家） | - |
| score | 1 \| 2 \| 3 \| 4 \| 5 | 评分（1-5星） | - |
| comment | string | 评论文本 | - |
| created_at | number | 评价创建时间 | 索引 |

**复合索引**：`[steam_id, reviewer_steam_id]` - 用于快速查询"我对某玩家的所有评价"

### 4.3 数据库索引说明

使用 Dexie.js 建立索引：
- matches 表：id（主键）, match_id, start_time, created_at
- players 表：steam_id（主键）, account_id, current_name, last_seen
- match_players 表：id（主键）, match_id, steam_id, [match_id+steam_id]（复合索引）
- reviews 表：id（主键）, match_id, steam_id, [steam_id+reviewer_steam_id]（复合索引）, created_at

---

## 5. 窗口架构

### 5.1 Overwolf 窗口类型

Overwolf 应用包含 3 种窗口类型：

#### Background Window（后台窗口）
- **用途**: 运行核心逻辑，监听游戏事件
- **生命周期**: 应用启动时创建，始终运行
- **不可见**: 不显示 UI，纯逻辑层
- **职责**:
  - 监听 Overwolf GEP 事件
  - 管理数据库操作
  - 控制其他窗口的打开/关闭
  - 处理系统托盘交互

#### Desktop Window（桌面窗口）
- **用途**: Dota 2 未运行时显示的主界面
- **显示时机**: 
  - 应用启动时（如果 Dota 2 未运行）
  - 用户通过托盘图标或快捷键打开
  - 游戏结束返回桌面后
- **包含页面**:
  - 主页（历史战绩概览）
  - 数据页（详细数据表格）
  - 设置页

#### InGame Window（游戏内窗口）
- **用途**: 游戏内 Overlay，显示记录和点评
- **显示时机**: 
  - 策略时间阶段（STRATEGY_TIME）：记录模式
  - 游戏结束阶段（TEAM_SHOWCASE）：点评模式
- **两种形态**:
  - 记录小窗：只读，显示玩家历史评分
  - 点评小窗：可交互，评分和评论

### 5.2 窗口生命周期流程

**应用启动流程**：
1. Background Window 启动（始终运行）
2. 检测 Dota 2 是否运行
   - 未运行：显示 Desktop Window
   - 运行中：监听游戏状态

**游戏内流程**：
1. STRATEGY_TIME 阶段：显示 InGame Window（记录模式）
2. 用户可按 Alt+` 隐藏窗口
3. TEAM_SHOWCASE 阶段：显示 InGame Window（点评模式）
4. 游戏结束返回主菜单：关闭 InGame Window
5. 退出 Dota 2：显示 Desktop Window

### 5.3 快捷键功能

| 快捷键 | 游戏内 | 游戏外 | 功能 |
|--------|--------|--------|------|
| Alt+` | ✓ | ✓ | 切换当前窗口显示/隐藏 |

**行为说明**：
- 游戏内：切换 InGame Window 显示/隐藏
- 游戏外：切换 Desktop Window 显示/隐藏
- 可在设置页自定义快捷键

---

## 6. 页面设计

### 6.1 系统托盘

#### 托盘图标
- 应用启动时在任务栏右下角显示图标
- 图标状态：
  - 灰色：Dota 2 未运行
  - 绿色：Dota 2 运行中
  - 红色：启动参数检查失败（未添加 `-gamestateintegration`）

#### 右键菜单
```
┌─────────────────────┐
│ 打开主窗口          │
│ 打开数据页          │
│ 打开设置页          │
│ ──────────────────  │
│ 检查启动参数        │
│ ──────────────────  │
│ 退出                │
└─────────────────────┘
```

**菜单说明**：
- **打开主窗口**: 打开 Desktop Window 主页
- **打开数据页**: 直接打开 Desktop Window 的数据 Tab
- **打开设置页**: 直接打开 Desktop Window 的设置 Tab
- **检查启动参数**: 检测用户是否添加了 `-gamestateintegration` 参数，未添加则显示引导提示
- **退出**: 关闭应用

### 6.2 Desktop Window（桌面窗口）

#### 6.2.1 窗口属性
- 大小：1200x800（可调整大小）
- 可最小化、最大化、关闭
- 位置记忆（记住用户上次关闭的位置和大小）

#### 6.2.2 主页 (Home)

**布局**：
```
┌─────────────────────────────────┐
│  主页  │  数据  │  设置           │ (Tab 导航)
├─────────────────────────────────┤
│                                 │
│  [个人战绩统计卡片]              │
│  ┌───────┬───────┬───────┐      │
│  │总对局 │ 胜率  │评分给出│      │
│  │ 128   │ 52%   │  85    │      │
│  └───────┴───────┴───────┘      │
│                                 │
│  最近对局                        │
│  ┌─────────────────────────┐   │
│  │ 2025-11-02  天梯  胜利  │   │
│  │ 2025-11-01  普通  失败  │   │
│  │ 2025-11-01  快速  胜利  │   │
│  └─────────────────────────┘   │
│                                 │
│  常见队友/对手                   │
│  ┌─────────────────────────┐   │
│  │ 玩家A  ⭐4.8  (遇到15次) │   │
│  │ 玩家B  ⭐2.1  (遇到8次)  │   │
│  └─────────────────────────┘   │
│                                 │
└─────────────────────────────────┘
```

**功能**：
- 显示个人统计数据
- 最近对局列表（最新10场）
- 常见队友/对手列表（按遇到次数排序）
- 点击对局可查看详情

#### 6.2.3 数据页 (Data)

**布局**：3个 Tab 页展示数据表

```
┌─────────────────────────────────────┐
│  比赛  │  玩家  │  点评                │ (子Tab)
├─────────────────────────────────────┤
│  [筛选条件]                          │
│  游戏模式: [全部 ▼]  结果: [全部 ▼] │
│  时间范围: [最近30天 ▼]             │
├─────────────────────────────────────┤
│  [数据表格]                          │
│  ┌────┬──────┬──────┬──────┬────┐  │
│  │序号│时间  │模式  │结果  │详情│  │
│  ├────┼──────┼──────┼──────┼────┤  │
│  │ 1  │11-02 │天梯  │胜利  │[>] │  │
│  │ 2  │11-01 │普通  │失败  │[>] │  │
│  └────┴──────┴──────┴──────┴────┘  │
├─────────────────────────────────────┤
│  [分页器]                            │
│  < 1 2 3 ... 10 >   每页10条        │
└─────────────────────────────────────┘
```

**比赛表格列**：
- 序号、时间、游戏模式、结果、时长、击杀比分、操作（查看详情）

**玩家表格列**：
- Steam ID、昵称、曾用名、遇到次数、平均评分、最后遇到时间、操作（查看历史点评）

**点评表格列**：
- 比赛时间、被评价玩家、评分、评论、操作（编辑、删除）

**筛选功能**：
- 游戏模式筛选
- 时间范围筛选
- 评分范围筛选
- 关键词搜索（玩家昵称、评论内容）

#### 6.2.4 设置页 (Settings)

```
┌─────────────────────────────────┐
│  基础设置                        │
│  ┌─────────────────────────┐   │
│  │ 语言: [简体中文 ▼]      │   │
│  │ 快捷键: [Alt + `] [修改] │   │
│  └─────────────────────────┘   │
│                                 │
│  评分文案                        │
│  ┌─────────────────────────┐   │
│  │ ⭐⭐⭐⭐⭐: [夯        ] │   │
│  │ ⭐⭐⭐⭐  : [顶级      ] │   │
│  │ ⭐⭐⭐   : [普通人    ] │   │
│  │ ⭐⭐     : [NPC       ] │   │
│  │ ⭐      : [拉         ] │   │
│  │             [恢复默认]  │   │
│  └─────────────────────────┘   │
│                                 │
│  数据管理                        │
│  ┌─────────────────────────┐   │
│  │ [导出数据 (JSON)]       │   │
│  │ [导入数据]              │   │
│  │ [删除所有数据] (危险)   │   │
│  └─────────────────────────┘   │
│                                 │
│  关于                            │
│  ┌─────────────────────────┐   │
│  │ 版本: v1.0.0            │   │
│  │ Overwolf 应用ID: xxx    │   │
│  │ [查看使用说明]          │   │
│  │ [检查启动参数]          │   │
│  └─────────────────────────┘   │
└─────────────────────────────────┘
```

**设置项说明**：

1. **语言选项**：中文/English
2. **快捷键设置**：自定义显示/隐藏快捷键（默认 Alt+`）
3. **评分文案**：自定义5个星级的显示文案
4. **导出数据**：导出为 JSON 文件，包含所有数据表
5. **导入数据**：导入 JSON 文件，相同 ID 覆盖，冲突优先使用导入数据
6. **删除所有数据**：清空数据库（需要二次确认）
7. **检查启动参数**：检测 Dota 2 是否添加了 `-gamestateintegration` 参数

### 6.3 InGame Window（游戏内 Overlay）

#### 6.3.1 窗口属性
- 位置：屏幕中央偏上（可拖动）
- 大小：1000x600（固定大小）
- 半透明背景（黑色，80% 不透明度）
- 可通过快捷键隐藏，但不可关闭（需通过游戏状态自动控制）

#### 6.3.2 记录小窗（Record Mode）

**显示时机**：STRATEGY_TIME 阶段
**显示内容**：除自己外的9个玩家的历史评分

```
┌─────────────────────────────────────────────┐
│  玩家历史评分 - 策略时间               Alt+` 隐藏 │
├─────────────────────────────────────────────┤
│  天辉 (Radiant)                             │
│  ┌───────┬───────┬───────┬───────┬───────┐ │
│  │[英雄] │[英雄] │[英雄] │[英雄] │[英雄] │ │
│  │玩家A  │玩家B  │玩家C  │玩家D  │你     │ │
│  │⭐4.5  │⭐--   │⭐2.1  │⭐3.8  │      │ │
│  │(8次)  │(首次) │(3次)  │(12次)│      │ │
│  │上次:好│       │上次:挂│上次:稳│      │ │
│  └───────┴───────┴───────┴───────┴───────┘ │
│                                             │
│  夜魇 (Dire)                                │
│  ┌───────┬───────┬───────┬───────┬───────┐ │
│  │[英雄] │[英雄] │[英雄] │[英雄] │[英雄] │ │
│  │玩家E  │玩家F  │玩家G  │玩家H  │玩家I  │ │
│  │⭐4.2  │⭐5.0  │⭐--   │⭐1.5  │⭐3.0  │ │
│  │(5次)  │(2次)  │(首次) │(1次)  │(6次)  │ │
│  │上次:正│上次:夯│       │上次:拉│上次:普│ │
│  └───────┴───────┴───────┴───────┴───────┘ │
└─────────────────────────────────────────────┘
```

**卡片信息（每个玩家）**：
- 英雄头像（使用 Dota 2 官方图片）
- 玩家昵称
  - 如果有曾用名，显示 `当前名 (曾用名1, 曾用名2)`
  - 匿名玩家显示 "匿名玩家"
- 历史平均评分（⭐ + 数字，如 ⭐4.5）
  - 没有评价显示 `--`
  - 1-2星用红色，3星灰色，4-5星绿色
- 评价次数（如 `8次`，首次遇到显示 `首次`）
- 最后一次评论（如 `上次: 好队友`，最多10个字符）

**交互**：
- 只读，不可交互
- 可通过拖拽标题栏移动窗口位置
- Alt+` 隐藏窗口

#### 6.3.3 点评小窗（Review Mode）

**显示时机**：TEAM_SHOWCASE 阶段
**显示内容**：对所有9个玩家进行评分

```
┌─────────────────────────────────────────────┐
│  对局点评 - 请为本场玩家评分          [跳过][保存] │
├─────────────────────────────────────────────┤
│  ┌────────────┬────────────┬────────────┐   │
│  │ [英雄头像] │ [英雄头像] │ [英雄头像] │   │
│  │  玩家A     │  玩家B     │  玩家C     │   │
│  │  天辉      │  天辉      │  夜魇      │   │
│  │  ☆☆☆☆☆  │  ☆☆☆☆☆  │  ☆☆☆☆☆  │   │
│  │  [短评...] │  [短评...] │  [短评...] │   │
│  └────────────┴────────────┴────────────┘   │
│  ┌────────────┬────────────┬────────────┐   │
│  │ [英雄头像] │ [英雄头像] │ [英雄头像] │   │
│  │  玩家D     │  玩家E     │  玩家F     │   │
│  │  夜魇      │  天辉      │  夜魇      │   │
│  │  ☆☆☆☆☆  │  ☆☆☆☆☆  │  ☆☆☆☆☆  │   │
│  │  [短评...] │  [短评...] │  [短评...] │   │
│  └────────────┴────────────┴────────────┘   │
│  ┌────────────┬────────────┬────────────┐   │
│  │ [英雄头像] │ [英雄头像] │ [英雄头像] │   │
│  │  玩家G     │  玩家H     │  玩家I     │   │
│  │  夜魇      │  夜魇      │  天辉      │   │
│  │  ☆☆☆☆☆  │  ☆☆☆☆☆  │  ☆☆☆☆☆  │   │
│  │  [短评...] │  [短评...] │  [短评...] │   │
│  └────────────┴────────────┴────────────┘   │
└─────────────────────────────────────────────┘
```

**卡片信息（每个玩家）**：
- 英雄头像
- 玩家昵称
- 队伍标识（天辉/夜魇，用颜色区分）
- 5星评分组件（点击选择，默认未选）
- 短评输入框（单行，最多50字符，可选）

**按钮**：
- **跳过**：不保存任何评价，直接关闭窗口
- **保存**：保存所有已评分的玩家（未评分的玩家不记录），关闭窗口

**交互逻辑**：
- 用户可以选择性评价（不强制评价所有人）
- 只有点击了星星的玩家才会被记录
- 评论可选（可以只打分不评论）
- 保存后自动关闭窗口

---

## 7. 核心功能实现逻辑

### 7.1 启动参数检查

**目的**：确保用户正确配置了 Dota 2 启动参数

**实现逻辑**：
1. 使用 `overwolf.games.getGameInfo(7314)` 获取 Dota 2 游戏信息
2. 检查 `ProcessCommandLine` 字段是否包含 `-gamestateintegration`
3. 如果缺失，显示引导界面

**引导界面内容**：
- 标题：需要配置启动参数
- 步骤说明：
  1. 打开 Steam 库
  2. 右键 Dota 2 → 属性
  3. 在启动选项中添加：`-gamestateintegration`
  4. 重启 Dota 2
- 操作按钮：[复制参数] [打开 Steam] [我已完成]

### 7.2 玩家数据同步逻辑

**触发时机**：STRATEGY_TIME 阶段获取到 roster 数据时

**处理流程**：
1. 过滤掉本地玩家（自己），只处理其他9个玩家
2. 对每个玩家：
   - **首次遇到**：创建玩家记录，记录 steam_id、account_id、昵称、首次见到时间等
   - **已存在**：
     - 更新最后见到时间
     - 检查昵称是否变化
     - 如果昵称变化：将旧昵称加入曾用名列表（去重，不包含当前昵称）

### 7.3 比赛记录逻辑

**触发时机**：TEAM_SHOWCASE 阶段，获取 match_ended 事件和游戏数据

**处理流程**：
1. **创建比赛记录**：
   - 记录比赛ID（pseudo_match_id）、游戏模式、开始/结束时间
   - 记录胜负结果、本方队伍、双方击杀数
   
2. **记录玩家数据**：
   - 遍历所有10个玩家
   - 记录每个玩家在本场比赛中的：英雄、队伍、KDA、等级等
   - 存入 match_players 表

### 7.4 点评保存逻辑

**触发时机**：用户在点评小窗点击"保存"按钮

**处理流程**：
1. 遍历所有玩家的评分数据
2. 跳过未评分的玩家（用户可选择性评价）
3. 对每个已评分的玩家：
   - 保存点评记录到 reviews 表（match_id、steam_id、score、comment等）
   - 更新玩家表的统计字段（平均评分、评价次数、最后一次评分等）
4. 使用复合索引 `[steam_id, reviewer_steam_id]` 查询该玩家的所有历史评分
5. 计算新的平均分并更新

### 7.5 数据导出逻辑

**导出格式**：JSON 文件，包含以下内容：
- version: 数据格式版本号（如 "1.0"）
- export_time: 导出时间戳
- app_version: 应用版本号
- data: 包含四张表的所有数据（matches, players, match_players, reviews）
- metadata: 统计信息（总比赛数、总玩家数、总点评数）

**导出流程**：
1. 从 IndexedDB 读取所有四张表的数据
2. 组装成 JSON 格式
3. 生成文件名（格式：`dota2-reviews-2025-11-02.json`）
4. 触发浏览器下载

### 7.6 数据导入逻辑

**导入策略**：相同 ID 覆盖，冲突优先使用导入的数据

**导入流程**：
1. 读取 JSON 文件内容
2. 解析并验证数据格式
3. 检查版本号是否兼容
4. 使用数据库事务批量导入：
   - 使用 Dexie 的 `bulkPut` 方法
   - 相同 ID 的记录会被导入数据覆盖
5. 导入完成后显示统计信息（导入了多少条比赛、玩家、点评）

---

## 8. 技术实现要点

### 8.1 项目结构

```
dota2-player-performance-tier-list/
├── src/
│   ├── main/                      # Electron 主进程（Background Window）
│   │   ├── index.ts              # 入口文件
│   │   ├── overwolf/             # Overwolf API 封装
│   │   │   ├── gep.ts           # GEP 事件监听
│   │   │   ├── windows.ts       # 窗口管理
│   │   │   └── hotkeys.ts       # 快捷键管理
│   │   ├── database/             # 数据库操作
│   │   │   ├── db.ts            # Dexie 实例
│   │   │   ├── matches.ts       # 比赛相关操作
│   │   │   ├── players.ts       # 玩家相关操作
│   │   │   └── reviews.ts       # 点评相关操作
│   │   └── tray.ts               # 系统托盘
│   │
│   ├── renderer/                  # React 渲染进程
│   │   ├── desktop/              # Desktop Window
│   │   │   ├── App.tsx
│   │   │   ├── pages/
│   │   │   │   ├── HomePage.tsx
│   │   │   │   ├── DataPage.tsx
│   │   │   │   └── SettingsPage.tsx
│   │   │   └── components/
│   │   │
│   │   ├── ingame/               # InGame Window
│   │   │   ├── App.tsx
│   │   │   ├── RecordMode.tsx   # 记录小窗
│   │   │   ├── ReviewMode.tsx   # 点评小窗
│   │   │   └── components/
│   │   │       ├── PlayerCard.tsx
│   │   │       └── RatingStars.tsx
│   │   │
│   │   └── shared/               # 共享组件
│   │       ├── components/
│   │       └── hooks/
│   │
│   ├── shared/                    # 共享代码
│   │   ├── types/                # TypeScript 类型定义
│   │   │   ├── database.ts
│   │   │   ├── gep.ts
│   │   │   └── settings.ts
│   │   ├── constants/            # 常量定义
│   │   │   ├── game.ts          # 游戏相关常量
│   │   │   └── heroes.ts        # 英雄ID映射
│   │   └── utils/                # 工具函数
│   │       ├── time.ts
│   │       └── steam.ts         # Steam ID 转换
│   │
│   └── assets/                    # 静态资源
│       ├── icons/
│       └── locales/              # 国际化文件
│           ├── zh-CN.json
│           └── en-US.json
│
├── public/
│   └── manifest.json             # Overwolf Manifest
│
├── package.json
├── tsconfig.json
├── tailwind.config.js
└── README.md
```

### 8.2 Overwolf Manifest 配置要点

**基础配置**：
- manifest_version: 1
- type: WebApp
- minimum-overwolf-version: 0.250.0 或更高

**必需权限**：
- GameInfo: 获取游戏信息
- GameControl: 控制窗口
- Hotkeys: 注册快捷键

**游戏目标**：
- game_ids: [7314] （Dota 2）
- game_events: [7314]
- start_window: "background"

**窗口配置**：
1. **background**：后台窗口，is_background_page: true
2. **desktop**：桌面窗口，大小 1200x800，可调整
3. **ingame**：游戏内窗口，大小 1000x600，透明，in_game_only: true

**快捷键配置**：
- toggle_window: Alt+Oem3（即 Alt+`）

### 8.3 关键技术点

#### 8.3.1 GEP 事件监听
**实现要点**：
- 使用 `overwolf.games.events.setRequiredFeatures()` 注册需要的事件
- 必需的 features：game_state, match_state_changed, roster, match_info, me, match_ended
- 监听两类回调：
  - `onInfoUpdates2`：处理 info 更新（roster, match_info 等）
  - `onNewEvents`：处理事件（match_state_changed, match_ended 等）

#### 8.3.2 窗口管理
**实现要点**：
- 显示桌面窗口：使用 `overwolf.windows.restore('desktop')`
- 显示游戏内窗口：
  - 通过 `sendMessage` 传递模式参数（record/review）
  - 使用 `restore` 显示窗口
- 隐藏窗口：使用 `overwolf.windows.minimize()`

#### 8.3.3 数据库查询优化
**实现要点**：
- 使用复合索引 `[steam_id, reviewer_steam_id]` 快速查询玩家评分
- 冗余存储平均分、评价次数等统计字段，避免重复计算
- 查询时使用 Dexie 的 `where().equals()` 方法

---

## 9. 注意事项与风险

### 9.1 合规性
- ✅ 使用 Overwolf 官方 API，符合 Valve 和 Overwolf 的使用条款
- ✅ 不修改游戏内存或文件
- ✅ 不影响游戏公平性
- ⚠️ 发布前必须通过 Overwolf 平台审核

### 9.2 数据安全
- 所有数据存储在本地 IndexedDB
- 不上传任何数据到服务器
- 导出数据为明文 JSON，用户需自行保管
- 卸载应用前提醒用户备份数据

### 9.3 性能考虑
- 记录小窗展示时，同时查询9个玩家的数据，使用冗余字段优化
- 数据表格使用虚拟滚动（react-window）处理大量数据
- 定期清理超过1年的旧数据（可选，用户设置）

### 9.4 用户体验
- 首次启动时检查 `-gamestateintegration` 参数，提供清晰引导
- 策略时间只有30-60秒，记录小窗必须快速加载
- 点评小窗支持跳过，不强制用户评价

### 9.5 已知限制
- **仅支持标准10人模式**：不支持 1v1、3v3 等自定义模式
- **无法获取玩家头像**：只能使用英雄头像或默认占位图
- **匿名玩家无法识别**：Steam 隐私设置为私密的玩家会显示为"匿名"
- **观战模式不记录**：只记录玩家实际参与的游戏

---

## 10. 开发路线图

### Phase 1: 基础架构（2周）
- [ ] 搭建 Overwolf Electron 项目
- [ ] 配置 React + TypeScript + TailwindCSS
- [ ] 实现 Background/Desktop/InGame 三窗口架构
- [ ] 集成 shadcn/ui 组件库
- [ ] 搭建 IndexedDB 数据库（Dexie.js）

### Phase 2: GEP 集成（1周）
- [ ] 实现 GEP 事件监听
- [ ] 解析 roster、match_info 等数据
- [ ] 实现游戏状态机（监听状态变化）
- [ ] 实现启动参数检查

### Phase 3: 核心功能（3周）
- [ ] 实现玩家数据同步逻辑
- [ ] 实现比赛记录逻辑
- [ ] 实现记录小窗（显示历史评分）
- [ ] 实现点评小窗（评分和评论）
- [ ] 实现评分统计计算

### Phase 4: 数据管理（1周）
- [ ] 实现数据页表格（比赛/玩家/点评）
- [ ] 实现筛选和分页
- [ ] 实现数据导出/导入（JSON）
- [ ] 实现数据删除功能

### Phase 5: 设置与优化（1周）
- [ ] 实现设置页（快捷键、语言、评分文案）
- [ ] 实现系统托盘和右键菜单
- [ ] 实现多语言支持（i18n）
- [ ] 性能优化和测试

### Phase 6: 发布准备（1周）
- [ ] 准备 Overwolf 商店资源（图标、截图、描述）
- [ ] 编写用户使用说明
- [ ] 完整测试（各种游戏模式和场景）
- [ ] 提交 Overwolf 审核

**总计：9周（约2个月）**

---

## 11. 附录

### 11.1 Dota 2 GEP 参考链接
- 官方文档: https://dev.overwolf.com/ow-electron/live-game-data-gep/supported-games/dota-2
- 游戏 ID: 7314
- 示例应用: https://github.com/overwolf/sample-app

### 11.2 英雄 ID 映射
需要维护一个英雄 ID 到英雄名称的映射表，用于显示英雄头像。
参考: https://www.dota2.com/datafeed/herolist?language=schinese

### 11.3 评分文案默认值
| 星级 | 默认文案 | 英文 |
|------|---------|------|
| ⭐⭐⭐⭐⭐ | 夯 | Excellent |
| ⭐⭐⭐⭐ | 顶级 | Great |
| ⭐⭐⭐ | 普通人 | Normal |
| ⭐⭐ | NPC | Poor |
| ⭐ | 拉 | Terrible |

---

## 文档版本

- **版本**: v1.0
- **最后更新**: 2025-11-02
- **作者**: 产品团队